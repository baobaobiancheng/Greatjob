{% extends "base.html" %}

{% block content %}
<div class="banner">
    <img src="{{ url_for('static', filename='job_222.png') }}" alt="计算机就业上c职识">
</div>

<div class="job-info">
    <div class="info-row">
        <span class="label">职位类型</span>
        <span class="job-type-list">
            <a href="{{ url_for('index', job_type='不限', city=selected_city, title=search_title, search=search_query) }}"
                class="type-link {% if not selected_type or selected_type == '不限' %}active{% endif %}">不限</a>
            <a href="{{ url_for('index', job_type='全职', city=selected_city, title=search_title, search=search_query) }}"
                class="type-link {% if selected_type == '全职' %}active{% endif %}">全职</a>
            <a href="{{ url_for('index', job_type='兼职', city=selected_city, title=search_title, search=search_query) }}"
                class="type-link {% if selected_type == '兼职' %}active{% endif %}">兼职</a>
        </span>
    </div>
    <div class="info-row">
        <span class="label">就业城市</span>
        <span class="city-list">
            <a href="{{ url_for('index', city='全国', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if not selected_city or selected_city == '全国' %}active{% endif %}">全国</a>
            <a href="{{ url_for('index', city='北京', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '北京' %}active{% endif %}">北京</a>
            <a href="{{ url_for('index', city='上海', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '上海' %}active{% endif %}">上海</a>
            <a href="{{ url_for('index', city='广州', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '广州' %}active{% endif %}">广州</a>
            <a href="{{ url_for('index', city='深圳', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '深圳' %}active{% endif %}">深圳</a>
            <a href="{{ url_for('index', city='杭州', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '杭州' %}active{% endif %}">杭州</a>
            <a href="{{ url_for('index', city='天津', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '天津' %}active{% endif %}">天津</a>
            <a href="{{ url_for('index', city='西安', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '西安' %}active{% endif %}">西安</a>
            <a href="{{ url_for('index', city='苏州', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '苏州' %}active{% endif %}">苏州</a>
            <a href="{{ url_for('index', city='武汉', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '武汉' %}active{% endif %}">武汉</a>
            <a href="{{ url_for('index', city='厦门', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '厦门' %}active{% endif %}">厦门</a>
            <a href="{{ url_for('index', city='长沙', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '长沙' %}active{% endif %}">长沙</a>
            <a href="{{ url_for('index', city='成都', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '成都' %}active{% endif %}">成都</a>
            <a href="{{ url_for('index', city='郑州', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '郑州' %}active{% endif %}">郑州</a>
            <a href="{{ url_for('index', city='重庆', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '重庆' %}active{% endif %}">重庆</a>
            <a href="{{ url_for('index', city='其他城市', title=search_title, job_type=selected_type, search=search_query) }}"
                class="city-link {% if selected_city == '其他城市' %}active{% endif %}">其他城市</a>
        </span>
    </div>
    <div class="info-row">
        <span class="label">工作岗位</span>
        <span class="job-category-list">
            <a href="{{ url_for('index', title='', city=selected_city, job_type=selected_type, search=search_query) }}"
                class="category-link {% if not search_title %}active{% endif %}">全部</a>
            <a href="{{ url_for('index', title='开发', city=selected_city, job_type=selected_type, search=search_query) }}"
                class="category-link {% if search_title == '开发' %}active{% endif %}">开发</a>
            <a href="{{ url_for('index', title='算法', city=selected_city, job_type=selected_type, search=search_query) }}"
                class="category-link {% if search_title == '算法' %}active{% endif %}">算法</a>
            <a href="{{ url_for('index', title='数据', city=selected_city, job_type=selected_type, search=search_query) }}"
                class="category-link {% if search_title == '数据' %}active{% endif %}">数据</a>
            <a href="{{ url_for('index', title='测试', city=selected_city, job_type=selected_type, search=search_query) }}"
                class="category-link {% if search_title == '测试' %}active{% endif %}">测试</a>
            <a href="{{ url_for('index', title='运维', city=selected_city, job_type=selected_type, search=search_query) }}"
                class="category-link {% if search_title == '运维' %}active{% endif %}">运维</a>
            <a href="{{ url_for('index', title='产品', city=selected_city, job_type=selected_type, search=search_query) }}"
                class="category-link {% if search_title == '产品' %}active{% endif %}">产品</a>
            <a href="{{ url_for('index', title='设计', city=selected_city, job_type=selected_type, search=search_query) }}"
                class="category-link {% if search_title == '设计' %}active{% endif %}">设计</a>
            <a href="{{ url_for('index', title='安全', city=selected_city, job_type=selected_type, search=search_query) }}"
                class="category-link {% if search_title == '安全' %}active{% endif %}">安全</a>
        </span>
    </div>
    <div class="info-row">
        <span class="label">智能职位推荐</span>
        <div class="recommendation-container">
            <button class="recommendation-btn" onclick="toggleRecommendation()">
                <i class="fas fa-magic"></i>
                <span>智能推荐</span>
            </button>
        </div>
    </div>
</div>

<div class="position-section">
    <h2>热门岗位</h2>
    <div class="position-grid">
        {% for job in jobs %}
        <div class="position-card">
            <a href="{{ url_for('job_detail', job_id=job.id) }}" class="position-link">
                <div class="position-header">
                    <h3>{{ job.title }}</h3>
                    <span class="salary">{{ job.salary }}</span>
                </div>
                <div class="company-info">
                    <img src="{{ job.company_logo }}" alt="{{ job.company_name }}" class="company-logo">
                    <span class="company-name">{{ job.company_name }}</span>
                </div>
                <div class="position-tags">
                    {% for tag in job.tags %}
                    <span class="tag">{{ tag }}</span>
                    {% endfor %}
                </div>
                <div class="position-requirements">
                    <p><i class="icon-location"></i>{{ job.location }}</p>
                    <p><i class="icon-experience"></i>{{ job.experience }}</p>
                    <p><i class="icon-education"></i>{{ job.education }}</p>
                </div>
            </a>
            <div class="position-actions">
                <button class="apply-btn" onclick="applyJob('{{ job.id }}')">立即申请</button>
                <button class="save-btn" onclick="saveJob('{{ job.id }}')">收藏</button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="ai-assistant">
    <div class="assistant-box" onclick="toggleChatBox()">
        <i class="fas fa-robot"></i> 智能问答助手
    </div>
    <div class="chat-box" id="chatBox">
        <div class="chat-header">
            <span>AI助手</span>
            <button class="close-btn" onclick="toggleChatBox()">×</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                <div class="message-content">
                    你好！我是你的求职助手，请问有什么可以帮你的吗？
                </div>
            </div>
        </div>
        <div class="chat-input">
            <textarea id="userInput" placeholder="输入你的问题..." rows="1" onkeydown="handleKeyPress(event)"></textarea>
            <button onclick="sendMessage()">发送</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let isRecommending = false;
    let originalJobs = null;

    function applyJob(jobId) {
        {% if user %}
        // 发送申请请求
        fetch('/apply-job/' + jobId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('申请成功！');
                } else {
                    alert(data.message);
                }
            });
        {% else %}
        window.location.href = "{{ url_for('login') }}";
        {% endif %}
    }

    function saveJob(jobId) {
        {% if user %}
        // 发送收藏请求
        fetch('/save-job/' + jobId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('收藏成功！');
                } else {
                    alert(data.message);
                }
            });
        {% else %}
        window.location.href = "{{ url_for('login') }}";
        {% endif %}
    }

    function toggleChatBox() {
        const chatBox = document.getElementById('chatBox');
        chatBox.classList.toggle('active');
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    function sendMessage() {
        const input = document.getElementById('userInput');
        const message = input.value.trim();

        if (message) {
            // 添加用户消息到对话框
            addMessage(message, 'user');

            // 发送消息到后端
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
                .then(response => response.json())
                .then(data => {
                    // 添加AI助手的回复
                    addMessage(data.response, 'assistant');
                })
                .catch(error => {
                    console.error('Error:', error);
                    addMessage('抱歉，出现了一些问题，请稍后再试。', 'assistant');
                });

            // 清空输入框
            input.value = '';
        }
    }

    function addMessage(content, type) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.innerHTML = `
            <div class="message-content">
                ${content}
            </div>
        `;
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function toggleRecommendation() {
        const btnIcon = document.querySelector('.recommendation-btn i');
        const btnText = document.querySelector('.recommendation-btn span');

        if (!isRecommending) {
            // 保存原始职位列表
            if (!originalJobs) {
                const positionGrid = document.querySelector('.position-grid');
                originalJobs = positionGrid.innerHTML;
            }

            // 发送推荐请求
            fetch('/recommend-jobs')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 更新职位列表
                        const positionGrid = document.querySelector('.position-grid');
                        positionGrid.innerHTML = ''; // 清空现有内容

                        // 添加推荐类型提示
                        const recommendTypeDiv = document.createElement('div');
                        recommendTypeDiv.className = 'recommend-type';
                        recommendTypeDiv.innerHTML = `<span>推荐方式: ${data.recommendation_type}</span>`;

                        // 如果是基于内容推荐且有推荐原因，显示原因
                        if (data.recommendation_type === '基于内容推荐' && data.recommendation_reason) {
                            recommendTypeDiv.innerHTML += `<p class="recommend-reason">${data.recommendation_reason}</p>`;

                            // 添加数据统计信息
                            recommendTypeDiv.innerHTML += `
                                <div class="recommend-stats">
                                    <div class="stat-item">收藏职位: <span>${data.saved_count}</span></div>
                                    <div class="stat-item">已投递: <span>${data.applied_count}</span></div>
                                    <div class="stat-item">需要达到: <span>5</span></div>
                                </div>
                            `;
                        } else if (data.recommendation_type === '协同过滤推荐') {
                            // 协同过滤推荐的提示信息
                            recommendTypeDiv.innerHTML += `
                                <p class="recommend-reason">基于您与其他用户的相似行为推荐</p>
                                <div class="recommend-stats">
                                    <div class="stat-item">收藏职位: <span>${data.saved_count}</span></div>
                                    <div class="stat-item">已投递: <span>${data.applied_count}</span></div>
                                </div>
                            `;
                        }

                        positionGrid.appendChild(recommendTypeDiv);

                        data.jobs.forEach(job => {
                            const jobCard = document.createElement('div');
                            jobCard.className = 'position-card';
                            jobCard.innerHTML = `
                                <a href="/job/${job.id}" class="position-link">
                                    <div class="position-header">
                                        <h3>${job.title}</h3>
                                        <span class="salary">${job.salary}</span>
                                    </div>
                                    <div class="company-info">
                                        <img src="${job.company_logo}" alt="${job.company_name}" class="company-logo">
                                        <span class="company-name">${job.company_name}</span>
                                    </div>
                                    <div class="position-tags">
                                        ${job.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                    </div>
                                    <div class="position-requirements">
                                        <p><i class="icon-location"></i>${job.location}</p>
                                        <p><i class="icon-experience"></i>${job.experience}</p>
                                        <p><i class="icon-education"></i>${job.education}</p>
                                    </div>
                                </a>
                                <div class="position-actions">
                                    <button class="apply-btn" onclick="applyJob('${job.id}')">立即申请</button>
                                    <button class="save-btn" onclick="saveJob('${job.id}')">收藏</button>
                                </div>
                            `;
                            positionGrid.appendChild(jobCard);
                        });

                        // 更新按钮状态
                        btnText.textContent = '取消推荐';
                        btnIcon.className = 'fas fa-times';
                        isRecommending = true;
                    } else {
                        alert(data.message);
                    }
                });
        } else {
            // 恢复原始职位列表
            if (originalJobs) {
                const positionGrid = document.querySelector('.position-grid');
                positionGrid.innerHTML = originalJobs;
            }

            // 更新按钮状态
            btnText.textContent = '智能推荐';
            btnIcon.className = 'fas fa-magic';
            isRecommending = false;
        }
    }
</script>
{% endblock %}